<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸŽ¥ Diffusion Control Panel</title>
  <meta name="description" content="Sende Live-Bilder deiner Webcam an Stable Diffusion zur Bildgenerierung.">
  <style>
    :root {
      --bg: #f4f4f8;
      --fg: #222;
      --input-bg: #fff;
      --input-border: #ccc;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1e1e1e;
        --fg: #eee;
        --input-bg: #2a2a2a;
        --input-border: #555;
      }
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      flex-direction: row;
      height: 100vh;
    }

    .left, .right {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    h1 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    video, img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    input[type="text"] {
      width: 100%;
      padding: 0.6rem;
      margin: 0.5rem 0 1rem 0;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      font-size: 1rem;
      color: var(--fg);
    }

    .slider-group {
      margin-bottom: 1.5rem;
    }

    .slider-group label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: bold;
    }

    .slider-group span {
      font-weight: normal;
      float: right;
    }

    input[type="range"] {
      width: 100%;
    }

    .info {
      margin-top: 1rem;
      font-style: italic;
      color: #666;
    }

    .error {
      color: red;
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="left">
    <h1>ðŸŽ¥ Kamera</h1>
    <video id="webcam" autoplay muted playsinline></video>

    <input type="text" id="prompt" placeholder="Beschreibe den Stilâ€¦" />
    <input type="text" id="negative_prompt" placeholder="Negativer Prompt (z.B. unerwÃ¼nschte Inhalte)â€¦" />

    <div class="slider-group">
      <label for="num_inference_steps">Inference Steps: <span id="steps_val">5</span></label>
      <input type="range" id="num_inference_steps" min="1" max="50" value="5"
             oninput="document.getElementById('steps_val').innerText = this.value">
    </div>

    <div class="slider-group">
      <label for="guidance_scale">Guidance Scale: <span id="scale_val">7.5</span></label>
      <input type="range" id="guidance_scale" min="1" max="15" step="0.1" value="7.5"
             oninput="document.getElementById('scale_val').innerText = this.value">
    </div>

    <div class="slider-group">
      <label for="strength">Image Strength: <span id="strength_val">0.35</span></label>
      <input type="range" id="strength" min="0.3" max="1" step="0.01" value="0.5"
             oninput="document.getElementById('strength_val').innerText = this.value">
    </div>

    <div class="info"><span id="latency">Warte auf Bildâ€¦</span></div>
    <div id="error" class="error" style="display:none;"></div>
  </div>

  <div class="right">
    <h1>ðŸŽ¨ Ergebnis</h1>
    <video id="processedVideo" controls autoplay muted playsinline style="display:none;"></video>
    <img id="processedImage" style="display:none; max-width:100%;" />
  </div>

<script>
  const video = document.getElementById('webcam');
  const promptInput = document.getElementById('prompt');
  const latencyDisplay = document.getElementById('latency');
  const errorBox = document.getElementById('error');

  let delay = 1000;

  async function startWebcam() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (err) {
      showError("Kein Zugriff auf Kamera: " + err.message);
    }
  }

  async function getFrameBlob(video) {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
  }

  async function sendImage() {
    const blob = await getFrameBlob(video);
    if (!blob) return showError("Konnte Bildblob nicht erstellen");

    const form = new FormData();
    form.append("strength", document.getElementById('strength').value);
    form.append("input", blob, "frame.png");
    form.append("prompt", promptInput.value || "artistic style");
    form.append("negative_prompt", document.getElementById('negative_prompt').value || "");
    form.append("steps", document.getElementById('num_inference_steps').value);
    form.append("scale", document.getElementById('guidance_scale').value);
    form.append("seed", "33");
    form.append("model", "lykon/dreamshaper-8");

    const start = performance.now();

    try {
      const res = await fetch("/generate", { method: "POST", body: form });
      if (!res.ok) throw new Error("Server antwortete mit Status " + res.status);
      const base64str = await res.text();
      const dataUrl = "data:image/png;base64," + base64str.trim();

      const processedImage = document.getElementById("processedImage");
      const processedVideo = document.getElementById("processedVideo");

      processedVideo.style.display = "none";
      processedVideo.pause();
      processedVideo.src = "";

      processedImage.style.display = "block";
      processedImage.src = dataUrl;

      const latency = (performance.now() - start) / 1000;
      latencyDisplay.textContent = `Verarbeitung: ${latency.toFixed(2)} Sekunden`;
      errorBox.style.display = "none";
    } catch (e) {
      showError("Fehler beim Senden: " + e.message);
    }
  }

  function showError(msg) {
    errorBox.textContent = msg;
    errorBox.style.display = "block";
  }

  async function loop() {
    await sendImage();
    setTimeout(loop, delay);
  }

  startWebcam().then(loop);
</script>

</body>
</html>
